# Android Development Guide

This document provides comprehensive guidance for developing, building, and deploying the Simple Wiki Android application.

## Overview

Simple Wiki uses [Capacitor 7](https://capacitorjs.com/) to wrap the web application as a native Android app. The Android project structure is generated by Capacitor, with specific customizations documented below.

## Architecture

```
android/
├── app/                          # Main application module
│   ├── build.gradle             # App-specific build config (customized)
│   ├── src/main/
│   │   ├── java/.../MainActivity.java  # Entry point (custom package name)
│   │   ├── AndroidManifest.xml  # App manifest (generated)
│   │   └── assets/public/       # Web assets (synced from static/)
│   └── src/test/                # Unit tests (add tests here)
├── build.gradle                 # Root build config (Kotlin plugin added)
├── variables.gradle             # Version management (test frameworks added)
└── capacitor.settings.gradle    # Capacitor plugin config
```

## What Was Customized vs Generated

### Generated by Capacitor

- `android/app/src/main/AndroidManifest.xml` - Generated by `cap add android`
- `android/app/src/main/res/**` - All resource files (icons, splash screens)
- `android/gradle/**` - Gradle wrapper files
- `android/settings.gradle` - Basic project structure

### Customized Files

1. **`android/app/src/main/java/com/github/brendanjerwin/simple_wiki/MainActivity.java`**
   - Custom package name matching `com.github.brendanjerwin.simple_wiki`
   - Default Capacitor MainActivity would use wrong package

2. **`android/build.gradle`**
   - Added Kotlin Gradle plugin `2.0.0` for test support

3. **`android/app/build.gradle`**
   - Added `kotlin-android` plugin
   - Configured JUnit 5 test platform
   - Added test dependencies (JUnit 5, MockK, AndroidX Test)

4. **`android/variables.gradle`**
   - Added version variables for test frameworks:
     - `junit5Version = '5.11.0'`
     - `mockkVersion = '1.13.12'`
     - `androidxTestCoreVersion`, etc.

## Prerequisites

### Required Tools

All tools are managed by `devbox` for reproducibility:

- **JDK 21** - Required by Capacitor 7
- **Android SDK Platform 34** - Target platform
- **Android Build Tools 34.0.0** - For building APKs
- **Gradle** - Build system (version managed by wrapper)
- **Bun** - For running Capacitor CLI

### One-Time Setup

1. **Install Android SDK**:

   ```bash
   devbox shell
   devbox run android:setup
   ```

   This downloads and installs the Android SDK to `~/.android-sdk`. The script:
   - Downloads command-line tools from Google
   - Accepts SDK licenses automatically
   - Installs required platform and build tools
   - Configures environment variables

2. **Verify Installation**:

   ```bash
   which adb
   adb --version
   ```

## Development Workflow

### Building for Local Development

When building for local development, the app connects to your local Go server:

```bash
# 1. Ensure Go server is running
devbox services start

# 2. Sync web assets to Android project (with dev config)
devbox run android:sync

# 3. Build debug APK
devbox run android:build:debug

# 4. Install on device/emulator
devbox run android:install
```

**How it works**: The `android:sync` command sets `CAPACITOR_DEV=true`, which configures `capacitor.config.ts` to point to `http://localhost:8050`.

### Building for Production

For production builds, omit the `CAPACITOR_DEV` environment variable:

```bash
# Sync assets without dev server config
bunx cap sync android
rm -rf android/app/src/main/assets/public/js/node_modules

# Build release APK
devbox run android:build:release
```

The production APK will serve the app from the bundled assets, not from a server.

### Development Commands

```bash
# Clean build artifacts
devbox run android:clean

# Run unit tests
devbox run android:test

# Open Android Studio (if installed)
open -a "Android Studio" android/
```

## Environment Variables

### `CAPACITOR_DEV`

Controls whether the app connects to a local development server.

- **Set to `true`**: App uses `http://localhost:8050` (for development)
- **Unset or `false`**: App serves from bundled assets (for production)

Used in `capacitor.config.ts`:

```typescript
const isDevelopment = process.env.CAPACITOR_DEV === 'true';
```

### `ANDROID_SETUP_NON_INTERACTIVE`

Prevents the Android SDK setup script from prompting for user input.

- **Set to `1`**: Skip interactive prompts (for CI/CD)
- **Unset**: Allow interactive mode (for local setup)

Used in `.devbox_run_scripts/setup_android_sdk.sh`.

### `CI`

Controls Gradle daemon behavior for build performance vs reproducibility.

- **Set to `true`**: Disables Gradle daemon (for CI/CD)
- **Unset or `false`**: Enables Gradle daemon (for local development)

Used in `.devbox_run_scripts/setup_android_env.sh`.

## Testing

### Running Tests

```bash
devbox run android:test
```

Runs all JUnit 5 unit tests in `android/app/src/test/`.

### Test Framework Stack

- **JUnit 5 (Jupiter)** - Test runner with modern assertions
- **MockK** - Kotlin-native mocking library
- **AndroidX Test Core** - Android testing utilities

### Writing Tests

Place tests in `android/app/src/test/java/com/github/brendanjerwin/simple_wiki/`:

```kotlin
package com.github.brendanjerwin.simple_wiki

import org.junit.jupiter.api.Test
import org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.DisplayName

class MyFeatureTest {
    @Test
    @DisplayName("Feature should behave correctly")
    fun featureBehavesCorrectly() {
        // Arrange
        val expected = "value"

        // Act
        val actual = myFeature.doSomething()

        // Assert
        assertEquals(expected, actual)
    }
}
```

Follow the project's TDD conventions (Context-Specification style, AAA pattern).

## CI/CD

### GitHub Actions Workflow

The Android CI workflow (`.github/workflows/android.yml`) runs on every push and PR:

1. **Build Job**:
   - Sets up devbox
   - Installs Android SDK (non-interactive mode)
   - Syncs Capacitor assets
   - Builds debug APK
   - Uploads APK as artifact (retained 30 days)

2. **Test Job**:
   - Sets up devbox
   - Installs Android SDK
   - Runs unit tests

Both jobs set `CI=true` to disable the Gradle daemon for reproducibility.

## Troubleshooting

### "SDK location not found"

**Problem**: Android SDK not installed or environment not configured.

**Solution**:

```bash
devbox run android:setup
# Then restart your devbox shell
exit
devbox shell
```

### "Failed to accept Android SDK licenses"

**Problem**: SDK licenses not accepted, preventing builds.

**Solution**:

```bash
$HOME/.android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses
```

Accept all licenses when prompted.

### "Cannot connect to localhost:8050"

**Problem**: Development APK can't reach local Go server.

**Cause**: Mobile devices/emulators can't access `localhost` from the host machine.

**Solutions**:

- **Android Emulator**: Use `10.0.2.2` instead of `localhost`
- **Physical Device**: Use your computer's local network IP (e.g., `192.168.1.100`)
- Update `capacitor.config.ts` temporarily for testing:

  ```typescript
  url: 'http://10.0.2.2:8050',  // For emulator
  // or
  url: 'http://192.168.1.100:8050',  // For physical device
  ```

### Build Fails with "Execution failed for task ':app:mergeDebugAssets'"

**Problem**: `node_modules` were accidentally synced into Android assets, causing the APK to exceed size limits.

**Solution**: This is automatically prevented by the `android:sync` script, which removes `node_modules` after syncing. If you see this error, run:

```bash
rm -rf android/app/src/main/assets/public/js/node_modules
devbox run android:build:debug
```

## Key Configurations

### Minimum SDK Version

Set in `android/variables.gradle`:

```gradle
minSdkVersion = 23  // Android 6.0 (Marshmallow)
```

### Target SDK Version

```gradle
compileSdkVersion = 34  // Android 14
targetSdkVersion = 34
```

### App Identification

- **Package Name**: `com.github.brendanjerwin.simple_wiki`
- **App Name**: "Simple Wiki"

## Regenerating Android Project

If you need to completely regenerate the Android project:

```bash
# ⚠️  This will DELETE all customizations!
rm -rf android/

# Regenerate Android project
bunx cap add android

# Reapply customizations (see "What Was Customized" section)
# - Update MainActivity.java package name
# - Add test dependencies to build.gradle
# - Add Kotlin plugin to root build.gradle
```

**Note**: Avoid regenerating unless absolutely necessary. Prefer updating specific files.

## Additional Resources

- [Capacitor 7 Documentation](https://capacitorjs.com/docs)
- [Android Developer Guide](https://developer.android.com/guide)
- [JUnit 5 User Guide](https://junit.org/junit5/docs/current/user-guide/)
- [MockK Documentation](https://mockk.io/)
