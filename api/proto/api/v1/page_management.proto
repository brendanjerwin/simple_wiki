syntax = "proto3";

package api.v1;

import "google/protobuf/struct.proto";

option go_package = "github.com/brendanjerwin/simple_wiki/gen/go/api/v1;apiv1";

service PageManagementService {
  rpc CreatePage(CreatePageRequest) returns (CreatePageResponse);
  rpc ReadPage(ReadPageRequest) returns (ReadPageResponse);
  rpc RenderPage(RenderPageRequest) returns (RenderPageResponse);
  rpc UpdatePage(UpdatePageRequest) returns (UpdatePageResponse);
  rpc UpdatePageContent(UpdatePageContentRequest) returns (UpdatePageContentResponse);
  rpc UpdateWholePage(UpdateWholePageRequest) returns (UpdateWholePageResponse);
  rpc DeletePage(DeletePageRequest) returns (DeletePageResponse);

  // GenerateIdentifier converts text to a wiki page identifier format.
  // Used by UI to auto-generate identifiers from titles and check availability.
  rpc GenerateIdentifier(GenerateIdentifierRequest) returns (GenerateIdentifierResponse);

  // ListTemplates returns all pages marked as templates (with template: true frontmatter).
  rpc ListTemplates(ListTemplatesRequest) returns (ListTemplatesResponse);
}

// Create Page
message CreatePageRequest {
  string page_name = 1;
  string content_markdown = 2;
  // Structured frontmatter data. TOML serialization happens at file persistence time.
  google.protobuf.Struct frontmatter = 3;
  // Optional template identifier. If provided, the template's frontmatter is used as a base,
  // with frontmatter merged on top (overriding template values).
  optional string template = 4;
}

message CreatePageResponse {
  bool success = 1;
  string error = 2;
}

// Read Page
message ReadPageRequest {
  string page_name = 1;
}

message ReadPageResponse {
  string content_markdown = 1;
  string front_matter_toml = 2;
  string rendered_content_html = 3;
  // rendered_content_markdown contains the markdown content after template expansion
  // but before HTML conversion. This is useful for LLM consumption as it provides
  // ~47% token savings compared to HTML while including all template-expanded content
  // like inventory lists from ShowInventoryContentsOf.
  string rendered_content_markdown = 4;
}

// Render Page
message RenderPageRequest {
  string page_name = 1;
}

message RenderPageResponse {
  string rendered_content_html = 1;
}

// Update Page
message UpdatePageRequest {
  string page_name = 1;
  string new_content_markdown = 2;
  string new_front_matter_toml = 3;
}

message UpdatePageResponse {
  bool success = 1;
  string error = 2;
}

// Update Page Content
message UpdatePageContentRequest {
  string page_name = 1;
  string new_content_markdown = 2;
}

message UpdatePageContentResponse {
  bool success = 1;
  string error = 2;
}

// Update Whole Page
message UpdateWholePageRequest {
  string page_name = 1;
  string new_whole_markdown = 2; // Markdown including front matter
}

message UpdateWholePageResponse {
  bool success = 1;
  string error = 2;
}

// Delete Page
message DeletePageRequest {
  string page_name = 1;
}

message DeletePageResponse {
  bool success = 1;
  string error = 2;
}

// Generate Identifier
message GenerateIdentifierRequest {
  // The text to convert to an identifier (typically a title).
  string text = 1;

  // If true, add suffix (e.g., _1, _2) to ensure no existing page has this identifier.
  bool ensure_unique = 2;
}

message GenerateIdentifierResponse {
  // The generated identifier (munged to wiki format, possibly with suffix if ensure_unique).
  string identifier = 1;

  // Whether this identifier is available (no existing page with this identifier).
  bool is_unique = 2;

  // Info about the existing page if is_unique is false.
  ExistingPageInfo existing_page = 3;
}

// Info about an existing page (used when identifier already exists).
message ExistingPageInfo {
  // The page identifier.
  string identifier = 1;

  // The page title from frontmatter.
  string title = 2;

  // The inventory.container value if this is an inventory item.
  string container = 3;
}

// List Templates
message ListTemplatesRequest {
  // Template identifiers to exclude from the results (e.g., ["inv_item"]).
  // This allows context-driven filtering of system-integrated templates.
  repeated string exclude_identifiers = 1;
}

message ListTemplatesResponse {
  repeated TemplateInfo templates = 1;
}

// Info about a template page.
message TemplateInfo {
  // The template page identifier.
  string identifier = 1;

  // The page title from frontmatter.
  string title = 2;

  // Optional description from frontmatter.
  string description = 3;
}
